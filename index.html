<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVUSFACE AI // INFINITY</title>
    
    <!-- FAVICON (Matte NF Logo) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231a1a1a'/%3E%3Ctext x='50' y='70' font-family='Arial' font-weight='900' font-size='50' fill='%2300ffcc' text-anchor='middle'%3ENF%3C/text%3E%3C/svg%3E">

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;700&family=Audiowide&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00ffcc;
            --accent: #0088ff;
            --bg: #050505;
            --panel-bg: rgba(15, 20, 25, 0.85);
            --text-main: #fff;
            --text-sub: #8899a6;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --radius: 16px;
            --blur: 20px;
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-body); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; transition: background 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        /* --- LOGO & HEADER --- */
        .header-deck { margin-top: 3rem; margin-bottom: 2rem; text-align: center; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .nf-emblem { width: 80px; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-family: var(--font-head); font-weight: 900; font-size: 2.5rem; color: var(--primary); background: rgba(30, 30, 30, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; position: relative; overflow: hidden; }
        .nf-title { font-family: var(--font-head); font-size: 3rem; font-weight: 800; letter-spacing: 4px; line-height: 1; margin-bottom: 0.5rem; color: var(--text-main); }
        .nf-subtitle { font-family: var(--font-body); font-size: 0.9rem; letter-spacing: 6px; color: var(--primary); text-transform: uppercase; font-weight: 600; opacity: 0.8; }

        /* --- INTERFACE --- */
        .main-interface { width: 95%; max-width: 600px; background: var(--panel-bg); border: var(--border); border-radius: var(--radius); backdrop-filter: blur(var(--blur)); padding: 2.5rem; position: relative; z-index: 10; box-shadow: 0 30px 80px rgba(0,0,0,0.4); transition: all 0.5s ease; }
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 2rem; padding: 4px; background: rgba(0,0,0,0.3); border-radius: calc(var(--radius) - 4px); }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 1px; color: var(--text-sub); border-radius: calc(var(--radius) - 8px); transition: 0.3s; text-transform: uppercase; }
        .tab.active { background: var(--primary); color: #000; font-weight: 800; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        .upload-stack { display: flex; flex-direction: column; gap: 20px; margin-bottom: 15px; }
        .drop-zone { position: relative; height: 110px; border: 2px dashed rgba(255,255,255,0.1); border-radius: var(--radius); background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: rgba(255,255,255,0.02); }
        .zone-text { text-align: center; pointer-events: none; z-index: 2; }
        .zone-title { font-size: 0.8rem; font-weight: 700; letter-spacing: 2px; color: var(--text-main); margin-bottom: 5px; }
        .preview-layer { position: absolute; width: 100%; height: 100%; top: 0; left: 0; object-fit: cover; opacity: 0.4; z-index: 1; display: none; filter: grayscale(50%); }

        /* --- FACE SELECTOR SYSTEM --- */
        .face-picker-label { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; display: none; }
        .face-selection-area { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; min-height: 100px; display: none; }
        .face-option { width: 80px; height: 80px; flex-shrink: 0; border-radius: 12px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; background-size: cover; background-position: center; position: relative; }
        .face-option.selected { border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.05); }
        .face-option:hover { border-color: var(--accent); }

        .process-btn { width: 100%; padding: 18px; background: var(--primary); color: #000; font-family: var(--font-head); font-weight: 900; letter-spacing: 3px; border: none; border-radius: var(--radius); cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .process-btn:hover { filter: brightness(1.1); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .process-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- CONSOLE & OUTPUT --- */
        .console-out { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--primary); margin-top: 20px; min-height: 25px; border-left: 3px solid var(--primary); padding-left: 15px; text-transform: uppercase; transition: 0.3s; }
        .accuracy-readout { font-size: 0.7rem; color: var(--text-sub); margin-top: 5px; display: none; }
        .output-stage { margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 2rem; display: none; text-align: center; }
        .final-render { max-width: 100%; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); }

        /* --- SIDEBAR --- */
        .menu-trigger { position: fixed; top: 2rem; right: 2rem; z-index: 100; width: 50px; height: 50px; border-radius: 50%; background: rgba(10,10,10,0.8); border: 1px solid var(--border); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: var(--text-main); }
        .sidebar { position: fixed; top: 0; right: 0; width: 360px; height: 100%; background: rgba(5, 5, 8, 0.96); backdrop-filter: blur(40px); border-left: 1px solid rgba(255,255,255,0.05); transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.7, 0, 0.2, 1); z-index: 99; padding: 2.5rem; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar.active { transform: translateX(0); }
        .theme-group { margin-bottom: 1.5rem; }
        .group-title { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .theme-chip { padding: 12px; font-size: 0.7rem; font-weight: 700; text-align: center; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); color: var(--text-sub); border-radius: 4px; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .theme-chip.active { border-color: var(--primary); background: rgba(var(--primary), 0.1); color: var(--primary); }

        .dev-footer { margin-top: 50px; margin-bottom: 20px; font-family: 'Montserrat', sans-serif; font-size: 0.7rem; color: var(--text-sub); letter-spacing: 2px; text-transform: uppercase; opacity: 0.6; }

        /* Themes Kept Same */
        [data-theme="origin"] { --primary: #00ffcc; --bg: #050a14; }
        [data-theme="cyberdeck"] { --primary: #00f3ff; --bg: #0b1015; }
        [data-theme="vapor"] { --primary: #ff00ff; --bg: #1a0033; }
        [data-theme="solar"] { --primary: #ffaa00; --bg: #001b24; }
        [data-theme="nordic"] { --primary: #A3C1DA; --bg: #1A2634; --text-main: #E0E6ED; }
        [data-theme="oasis"] { --primary: #48D1CC; --bg: #0F2027; }
        [data-theme="dusk"] { --primary: #C77DFF; --bg: #240046; }
        [data-theme="glacier"] { --primary: #E0FFFF; --bg: #0B1015; }
        [data-theme="aero"] { --primary: #007aff; --bg: #e0e5ec; --text-main: #1d1d1f; --panel-bg: rgba(255,255,255,0.6); }
        [data-theme="zen"] { --primary: #555; --bg: #f9f9f9; --text-main: #333; }
        [data-theme="chrome"] { --primary: #e0e0e0; --bg: #000; }
        [data-theme="royal"] { --primary: #d4af37; --bg: #080808; --font-head: 'Cinzel'; }

    </style>
</head>
<body data-theme="origin">

    <canvas id="bg-canvas"></canvas>

    <div class="menu-trigger" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </div>

    <div class="sidebar" id="sidebar">
        <h3>VISUAL SCHEMATICS</h3>
        <div class="theme-group">
            <div class="group-title">CALM & FOCUS</div>
            <div class="theme-grid">
                <div class="theme-chip" onclick="setTheme('nordic', this)">NORDIC</div>
                <div class="theme-chip" onclick="setTheme('oasis', this)">OASIS</div>
                <div class="theme-chip" onclick="setTheme('dusk', this)">DUSK</div>
                <div class="theme-chip" onclick="setTheme('glacier', this)">GLACIER</div>
            </div>
        </div>
        <div class="theme-group">
            <div class="group-title">STELLAR (Space)</div>
            <div class="theme-grid">
                <div class="theme-chip active" onclick="setTheme('origin', this)">ORIGIN</div>
                <div class="theme-chip" onclick="setTheme('cyberdeck', this)">CYBERDECK</div>
                <div class="theme-chip" onclick="setTheme('vapor', this)">VAPORWAVE</div>
                <div class="theme-chip" onclick="setTheme('solar', this)">SOLARPUNK</div>
            </div>
        </div>
    </div>

    <div class="header-deck">
        <div class="nf-emblem">NF</div>
        <div class="nf-title">NOVUSFACE</div>
        <div class="nf-subtitle">Infinity Engine</div>
    </div>

    <div class="main-interface">
        <div class="mode-tabs">
            <div class="tab active" onclick="setMode('single', this)">ACCURACY SWAP</div>
            <div class="tab" onclick="setMode('batch', this)">BATCH QUEUE</div>
        </div>

        <div id="view-single">
            <div class="upload-stack">
                <div class="drop-zone" onclick="document.getElementById('srcFile').click()">
                    <div class="zone-text"><div class="zone-title">SOURCE IDENTITY</div></div>
                    <input type="file" id="srcFile" hidden accept="image/*" onchange="preview(this, 'srcPrev')">
                    <img id="srcPrev" class="preview-layer">
                </div>
                <div class="drop-zone" onclick="document.getElementById('tgtFile').click()">
                    <div class="zone-text"><div class="zone-title">TARGET MEDIA</div></div>
                    <input type="file" id="tgtFile" hidden accept="image/*" onchange="handleTargetUpload(this)">
                    <img id="tgtPrev" class="preview-layer">
                </div>
            </div>

            <!-- Face Selection UI -->
            <div id="facePickerLabel" class="face-picker-label">TARGET SELECTION:</div>
            <div id="faceSelectionArea" class="face-selection-area"></div>

            <button class="process-btn" id="runSingleBtn" onclick="runSingle()">INITIALIZE SWAP</button>
            <div id="singleLog" class="console-out">>> SYSTEM READY</div>
            <div id="accuracyReadout" class="accuracy-readout">FORENSIC LOCK: --%</div>
        </div>

        <div id="view-batch" style="display:none;">
            <div class="upload-stack">
                <div class="drop-zone" onclick="document.getElementById('batchSrc').click()" style="border-color:var(--primary);">
                    <div class="zone-text"><div class="zone-title">MASTER IDENTITY</div></div>
                    <input type="file" id="batchSrc" hidden accept="image/*" onchange="preview(this, 'batchSrcPrev')">
                    <img id="batchSrcPrev" class="preview-layer">
                </div>
                <div class="drop-zone" onclick="document.getElementById('batchFiles').click()">
                    <div class="zone-text"><div class="zone-title">TARGET QUEUE</div><div id="batchCount" style="font-size:10px">0 LOADED</div></div>
                    <input type="file" id="batchFiles" hidden accept="image/*" multiple onchange="updateBatchCount(this)">
                </div>
            </div>
            <button class="process-btn" onclick="runBatch()">EXECUTE BATCH</button>
        </div>

        <div id="resultsArea" class="output-stage">
            <div id="singleResult"><img id="finalImg" class="final-render"><br><a id="dlLink" href="#" class="process-btn" style="display:inline-block; margin-top:10px; text-decoration:none;">DOWNLOAD</a></div>
            <div id="batchResult" class="batch-grid"></div>
        </div>
    </div>

    <div class="dev-footer">Developed by Nikhil Singh</div>

    <script>
        const BASE_API = "https://codewander-666-novusface-backend.hf.space";
        let currentAnimation = 'space'; 
        let selectedFaceId = 0;

        function setTheme(name, btn) {
            document.body.setAttribute('data-theme', name);
            document.querySelectorAll('.theme-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            if (['origin', 'cyberdeck', 'vapor', 'solar'].includes(name)) currentAnimation = 'space';
            else if (['nordic', 'oasis', 'dusk', 'glacier'].includes(name)) currentAnimation = 'calm';
            else currentAnimation = 'loop';
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        function setMode(mode, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('view-single').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('view-batch').style.display = mode === 'batch' ? 'block' : 'none';
        }

        function preview(input, id) { if(input.files && input.files[0]) { const img = document.getElementById(id); img.src = URL.createObjectURL(input.files[0]); img.style.display = 'block'; } }

        async function handleTargetUpload(input) {
            preview(input, 'tgtPrev');
            const file = input.files[0];
            if(!file) return;

            const log = document.getElementById('singleLog');
            const picker = document.getElementById('faceSelectionArea');
            const label = document.getElementById('facePickerLabel');
            
            log.innerText = ">> SCANNING FACES...";
            picker.innerHTML = "";
            
            const formData = new FormData();
            formData.append('target', file);

            try {
                const res = await fetch(`${BASE_API}/detect-target-faces`, { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.faces && data.faces.length > 0) {
                    label.style.display = 'block';
                    picker.style.display = 'flex';
                    data.faces.forEach((face, idx) => {
                        const div = document.createElement('div');
                        div.className = `face-option ${idx === 0 ? 'selected' : ''}`;
                        div.style.backgroundImage = `url(${face.thumbnail})`;
                        div.onclick = () => {
                            selectedFaceId = face.face_id;
                            document.querySelectorAll('.face-option').forEach(o => o.classList.remove('selected'));
                            div.classList.add('selected');
                        };
                        picker.appendChild(div);
                    });
                    selectedFaceId = data.faces[0].face_id;
                    log.innerText = ">> FACES DETECTED.";
                } else {
                    log.innerText = ">> NO TARGETS FOUND.";
                }
            } catch(e) {
                log.innerText = ">> SCAN ERROR.";
            }
        }

        async function runSingle() {
            const src = document.getElementById('srcFile').files[0];
            const tgt = document.getElementById('tgtFile').files[0];
            const log = document.getElementById('singleLog');
            const accuracy = document.getElementById('accuracyReadout');
            
            if(!src || !tgt) return alert("Select Identity & Media");
            
            log.innerText = ">> CALCULATING LOCK...";
            const formData = new FormData();
            formData.append('source', src);
            formData.append('target', tgt);
            formData.append('target_face_id', selectedFaceId);
            formData.append('accuracy_weight', 0.75);

            try {
                const res = await fetch(`${BASE_API}/swap`, { method: 'POST', body: formData });
                
                // Get Accuracy Score from Headers
                const score = res.headers.get('X-Identity-Accuracy');
                if(score) {
                    accuracy.innerText = `FORENSIC LOCK: ${(parseFloat(score)*100).toFixed(2)}%`;
                    accuracy.style.display = 'block';
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                document.getElementById('finalImg').src = url;
                document.getElementById('dlLink').href = url;
                document.getElementById('resultsArea').style.display = 'block';
                log.innerText = ">> INJECTION COMPLETE.";
            } catch(e) { 
                log.innerText = ">> PIPELINE ERROR."; 
            }
        }

        // --- ANIMATION ENGINE KEPT VERBATIM ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, stars = [];

        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            stars = [];
            for(let i=0; i<200; i++) stars.push({x:Math.random()*width, y:Math.random()*height, size:Math.random()*2, alpha:Math.random(), speed:0.01 + Math.random()*0.03});
        }
        window.addEventListener('resize', resize); resize();

        function animate() {
            const theme = document.body.getAttribute('data-theme');
            const primary = getComputedStyle(document.body).getPropertyValue('--primary').trim();
            ctx.fillStyle = (theme === 'zen' || theme === 'aero') ? "rgba(240,240,245,0.2)" : "rgba(5,5,8,0.2)";
            ctx.fillRect(0, 0, width, height);

            if (currentAnimation === 'space') {
                stars.forEach(s => {
                    s.alpha += s.speed;
                    if(s.alpha > 1 || s.alpha < 0) s.speed *= -1;
                    ctx.fillStyle = `rgba(${hexToRgb(primary)}, ${Math.abs(s.alpha)})`;
                    ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
                });
            } else if (currentAnimation === 'loop') {
                ctx.strokeStyle = primary; ctx.lineWidth = 1;
                ctx.beginPath();
                for(let i=0; i<width; i+=20) {
                    let y = height/2 + Math.sin(Date.now()*0.002 + i*0.01)*100;
                    ctx.lineTo(i, y);
                }
                ctx.stroke();
            } else if (currentAnimation === 'calm') {
                ctx.fillStyle = `rgba(${hexToRgb(primary)}, 0.05)`;
                for(let i=0; i<3; i++) {
                    ctx.beginPath();
                    let offset = i * 200;
                    ctx.moveTo(0, height);
                    for(let x=0; x<=width; x+=50) {
                        let y = height/2 + Math.sin(Date.now()*0.0005 + x*0.005 + offset)*100;
                        ctx.lineTo(x, y);
                    }
                    ctx.lineTo(width, height);
                    ctx.fill();
                }
            }
            requestAnimationFrame(animate);
        }

        function hexToRgb(hex) {
            if(hex.startsWith('#')) {
                let r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
                return `${r}, ${g}, ${b}`;
            }
            return "255, 255, 255";
        }
        animate();
    </script>
</body>
</html>
